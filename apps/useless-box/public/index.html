<!DOCTYPE html>
<html lang="en" x-data="{ isOn: false, logs: [] }">
<head>
  <meta charset="UTF-8">
  <title>Useless Box</title>

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.10" defer></script> 

  <!-- HTMX SSE Extension -->
  <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>

  <style>
    body { font-family: sans-serif; padding: 18px;}
    button { padding: 10px; font-size: 18px;}
  </style>
</head>
<body>
  
  <h1>Useless Box</h1>

  <!-- Toggle buttons POST /toggle -->
  <button
    hx-post = "/toggle"
    hx-trigger = "click"
      hx-vals = 'js: "on" : !this.dataset.on}'
      hx-headers =  '{"Content-Type":"application/json"}'
      hx-swap = "none"
      data-on = "false">
  Toggle
  </button>

  <h2>Status</h2>

  <!-- Live-updates from SSE -->
  <div id="status"
    hx-ext="sse"
    hx-sse="true"
    sse-connect="/state"
    sse-swap="state"
    x-text="isOn ? 'ON' : 'OFF'">
  </div>

  <script>
    const evtSource = new EventSource('/events') 

    evtSource.onmessage = e => {
      const state = e.data === 'true'
      const btn = document.getElementById('toggle')
      btn.dataset.on = state
      btn.textContent = state ? 'on' : 'off'
    }
    
    // adds error handling
    evtSource.onerror = () => {
      console.error('SSE error. Attempting to reconnect...')
    }

    // keeps UI in sync
    document.body.addEventListener('htmx:afterRequest', e => {
      const btn = e.target
      const newState = btn.dataset.on === 'true'
      btn.textContent = newState ? 'on' : 'off'
    })
  </script>
